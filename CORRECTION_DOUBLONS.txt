================================================================================
ğŸ”§ CORRECTION DU PROBLÃˆME DES DOUBLONS
================================================================================

ğŸ“‹ PROBLÃˆME IDENTIFIÃ‰
================================================================================

Avant la correction, pour un mÃªme cheval dans une mÃªme course, on avait plusieurs
entrÃ©es dans la table `cheval_courses_seen` :

Exemple avec "northern chill" dans la course R6 C7 du 2025-10-30:
   â€¢ 2025-10-30|R6|C7|KENTUCKY DOWNS
   â€¢ 2025-10-30|R6|C7|SARATOGA
   â€¢ 2025-10-30|R6|C7|CHURCHILL DOWNS
   â€¢ 2025-10-30|R6|C7|OAKLAWN PARK

ğŸ” CAUSE DU PROBLÃˆME
================================================================================

Le scraper enregistrait dans `cheval_courses_seen` :
1. âŒ La course ACTUELLE du jour (correct)
2. âŒ TOUTES les courses de l'HISTORIQUE du cheval (incorrect)

Les hippodromes "KENTUCKY DOWNS", "SARATOGA", etc. venaient des ANCIENNES courses
du cheval, pas de la course actuelle !

Le systÃ¨me confondait :
   â€¢ Course ACTUELLE : R6 C7 Ã  Churchill Downs (30/10/2025)
   â€¢ Performances PASSÃ‰ES : courses prÃ©cÃ©dentes du cheval Ã  diffÃ©rents hippodromes

================================================================================
âœ… SOLUTION IMPLÃ‰MENTÃ‰E
================================================================================

1. SÃ‰PARATION DES CONCEPTS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   
   Course actuelle (table `cheval_courses_seen`):
      â†’ Une seule entrÃ©e par cheval par course
      â†’ Format: DATE|R#|C#|HIPPODROME_ACTUEL
      â†’ Exemple: 2025-10-30|R6|C7|CHURCHILL DOWNS
   
   Performances passÃ©es (colonne `dernieres_performances` dans `chevaux`):
      â†’ StockÃ©es en JSON dans la table chevaux
      â†’ Contient les 5 derniÃ¨res courses avec dÃ©tails
      â†’ Format: [{"date": "...", "hippodrome": "...", "place": "...", "is_win": true/false}]

2. MODIFICATIONS DU CODE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   
   a) Fonction `fetch_performances()`:
      - âœ… RÃ©cupÃ¨re l'hippodrome ACTUEL en paramÃ¨tre
      - âœ… N'enregistre QUE la course actuelle dans `cheval_courses_seen`
      - âœ… Calcule les stats depuis l'historique (sans l'enregistrer)
      - âœ… Stocke les 5 derniÃ¨res performances en JSON

   b) Fonction `enrich_from_course()`:
      - âœ… RÃ©cupÃ¨re l'hippodrome de la course actuelle depuis l'API
      - âœ… Le passe Ã  `fetch_performances()`
   
   c) Table `chevaux`:
      - âœ… Nouvelle colonne `dernieres_performances` (TEXT/JSON)
      - âœ… Stocke l'historique complet des performances

3. STRUCTURE DE DONNÃ‰ES
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   
   Table `cheval_courses_seen`:
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ nom_norm        â”‚ race_key                           â”‚ annee â”‚ is_win â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚ northern chill  â”‚ 2025-10-30|R6|C7|CHURCHILL DOWNS   â”‚ 2025  â”‚ 0      â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      âœ UNE SEULE entrÃ©e par cheval par course !
   
   Colonne `chevaux.dernieres_performances` (JSON):
      [
         {"date": "2025-09-15", "hippodrome": "KENTUCKY DOWNS", "place": "3", "is_win": false},
         {"date": "2025-08-22", "hippodrome": "SARATOGA", "place": "5", "is_win": false},
         {"date": "2025-07-10", "hippodrome": "CHURCHILL DOWNS", "place": "2", "is_win": false},
         ...
      ]

================================================================================
ğŸ“Š RÃ‰SULTATS
================================================================================

AVANT la correction:
   â€¢ northern chill dans R6 C7: 4 entrÃ©es (doublons)
   â€¢ Historique mÃ©langÃ© avec les courses actuelles
   â€¢ Impossible de distinguer course actuelle vs performances passÃ©es

APRÃˆS la correction:
   â€¢ northern chill dans R6 C7: 1 SEULE entrÃ©e âœ…
   â€¢ Course actuelle clairement identifiÃ©e
   â€¢ Historique stockÃ© sÃ©parÃ©ment en JSON
   â€¢ Aucun doublon

================================================================================
ğŸš€ UTILISATION
================================================================================

1. NETTOYER ET RE-SCRAPER
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   
   $ python clean_and_rescrape.py
   
   â†’ Nettoie la table `cheval_courses_seen`
   â†’ Re-scrape toutes les courses du jour
   â†’ VÃ©rifie qu'il n'y a plus de doublons

2. VOIR LES PERFORMANCES D'UN CHEVAL
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   
   $ python voir_performances.py "nom du cheval"
   
   â†’ Affiche les infos du cheval
   â†’ Liste les 10 derniÃ¨res performances historiques
   â†’ Montre les courses actuelles (celles du jour)

3. VÃ‰RIFIER L'ABSENCE DE DOUBLONS
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   
   $ sqlite3 data/database.db "
   SELECT nom_norm, COUNT(*) as nb
   FROM cheval_courses_seen
   GROUP BY nom_norm
   HAVING COUNT(*) > 1;
   "
   
   â†’ Si aucun rÃ©sultat: âœ… Pas de doublons !

================================================================================
ğŸ’¡ AVANTAGES DE LA NOUVELLE ARCHITECTURE
================================================================================

âœ… DonnÃ©es plus propres
   â†’ Une seule entrÃ©e par cheval par course
   â†’ Pas de confusion entre course actuelle et historique

âœ… Meilleure performance
   â†’ Moins d'entrÃ©es dans `cheval_courses_seen`
   â†’ RequÃªtes plus rapides

âœ… Plus d'informations
   â†’ Historique complet des performances stockÃ©
   â†’ DÃ©tails accessibles (date, hippodrome, place, victoire)

âœ… Ã‰volutivitÃ©
   â†’ Facile d'ajouter des champs aux performances (distance, gains, etc.)
   â†’ Format JSON flexible

âœ… TraÃ§abilitÃ©
   â†’ On sait exactement quelles courses du jour ont Ã©tÃ© scrapÃ©es
   â†’ L'historique est conservÃ© sÃ©parÃ©ment

================================================================================
ğŸ“ NOUVEAUX FICHIERS
================================================================================

clean_and_rescrape.py    â†’ Nettoie et re-scrape avec la nouvelle logique
voir_performances.py     â†’ Visualise les performances d'un cheval

FICHIERS MODIFIÃ‰S:

scraper_pmu_simple.py    â†’ Logique corrigÃ©e pour Ã©viter les doublons
   â€¢ fetch_performances() : ne stocke que la course actuelle
   â€¢ enrich_from_course() : rÃ©cupÃ¨re l'hippodrome actuel
   â€¢ db_setup() : ajoute la colonne dernieres_performances
   â€¢ upsert_cheval_counts() : stocke les performances en JSON

================================================================================
âœ… PROBLÃˆME RÃ‰SOLU !
================================================================================

Le cheval "northern chill" (et tous les autres) n'apparaÃ®t maintenant qu'UNE SEULE 
FOIS pour la course R6 C7, avec le bon hippodrome (CHURCHILL DOWNS).

Les anciennes performances sont conservÃ©es dans la colonne `dernieres_performances`
et peuvent Ãªtre consultÃ©es facilement avec le script `voir_performances.py`.

================================================================================
